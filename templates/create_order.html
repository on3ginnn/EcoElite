{% extends 'base.html' %}

{% block title %}Новый заказ - EcoElite{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h1 class="fw-bold mb-4">Создание заказа</h1>
            
            <div class="card card-premium">
                <div class="card-body p-4">
                    <form method="post" id="orderForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Адрес обслуживания *</label>
                                {{ form.address }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Дата *</label>
                                {{ form.service_date }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Время *</label>
                                {{ form.service_time }}
                                <div id="timeLoading" class="mt-2" style="display: none;">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Загрузка...</span>
                                    </div>
                                    <small class="text-muted ms-2">Загрузка доступного времени</small>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Тариф</label>
                                <select class="form-select" disabled>
                                    <option>Базовое обслуживание - 15 000 ₽</option>
                                    <option>Премиум обслуживание - 25 000 ₽</option>
                                    <option>Экстренный выезд - 35 000 ₽</option>
                                </select>
                                <small class="text-muted">Тариф можно изменить после создания заказа</small>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Особые пожелания</label>
                            {{ form.notes }}
                        </div>

                        <div class="alert alert-info">
                            <h6><i class="bi bi-info-circle me-2"></i>Важно</h6>
                            <ul class="mb-0">
                                <li>Подтверждение заказа происходит в течение 2 часов</li>
                                <li>Отмена заказа возможна не менее чем за 24 часа до визита</li>
                                <li>Оплата происходит автоматически после выполнения работ</li>
                            </ul>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'orders' %}" class="btn btn-secondary me-md-2">Отмена</a>
                            <button type="submit" class="btn btn-gold">Создать заказ</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Добавляем классы к полям формы
        const inputs = document.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.classList.add('form-control');
        });

        // Загрузка доступного времени при изменении даты
        const dateInput = document.getElementById('id_service_date');
        const timeSelect = document.getElementById('id_service_time');
        const timeLoading = document.getElementById('timeLoading');

        dateInput.addEventListener('change', function() {
            if (this.value) {
                timeLoading.style.display = 'block';
                timeSelect.disabled = true;
                
                fetch(`/api/available-times/?date=${this.value}`)
                    .then(response => response.json())
                    .then(data => {
                        timeSelect.innerHTML = '';
                        if (data.times) {
                            data.times.forEach(time => {
                                const option = document.createElement('option');
                                option.value = time;
                                option.textContent = time;
                                timeSelect.appendChild(option);
                            });
                        }
                        timeLoading.style.display = 'none';
                        timeSelect.disabled = false;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        timeLoading.style.display = 'none';
                        timeSelect.disabled = false;
                    });
            }
        });
    });
</script>
{% endblock %}